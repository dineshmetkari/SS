package com.stackroute.messaging;

import java.io.IOException;
import java.lang.reflect.Type;
import java.util.ArrayList;

import org.json.JSONException;
import org.json.JSONObject;
import org.springframework.amqp.AmqpException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import com.stackroute.model.UserInput;
import com.stackroute.redisson.FetchUrl;
import com.stackroute.service.FetchNeoUrl;

@Component
public class Receiver {
	

	@Autowired
	private FetchNeoUrl fetchNeoUrl;
	@Autowired
	private UserInput userInput;
	@Autowired
	private Publish publish;
	
	private String json;
	
	 public  void receiveMessage(String message) {
	        System.out.println("Received <" + message + ">");
			String fetchedMessage=message;
			
			Gson gson = new Gson();
			Type type = new TypeToken<UserInput>() {}.getType();
			
				userInput = gson.fromJson(fetchedMessage, type);
				String domain = userInput.getDomain();
				String concept = userInput.getConcept();
				String intent =userInput.getIntent();
				String sessionId = userInput.getSessionId();
				String type1 = userInput.getType();
				
				System.out.println(domain + " " + concept +" "+intent);
				ArrayList<FetchUrl> fetchList	=fetchNeoUrl.fetchedUrl(domain, concept, intent);
				JSONObject jo = new JSONObject();
				try {
				if(fetchList.isEmpty()){
					json = "{\"message\":\"Urls not populated yet\",\"concept\":\""+concept+"\",\"domain\":\""+domain+"\"}";
					jo.put("sessionId", sessionId);
					jo.put("type", type1);
					jo.put("Response", fetchList);
					jo.put("message", json);
				
				}else{
						jo.put("sessionId", sessionId);
						jo.put("type", type1);
						jo.put("Response", fetchList);
					} 
					 
						publish.publishMsg(jo.toString());
					} catch (AmqpException | IOException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					catch (JSONException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					
			
					
	    }
}
